<%- @services.each do |name, svc| -%>
upstream <%= name %> {
         server <%= svc['hostname'] %>:<%= svc['port'] %>;
         keepalive <%= svc['keepalive'] || @keepalive %>;
}

server {
    listen 127.0.0.1:<%= svc['localport'] %>;
    listen [::1]:<%= svc['localport'] %>;

    location / {
        proxy_pass <%= svc['scheme'] %>://<%= name %>;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_read_timeout     <%= svc['timeout'] %>;
        proxy_connect_timeout  <%= svc['connect_timeout'] || @connect_timeout %>;
    }
}
<%- end -%>
