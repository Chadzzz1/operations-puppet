<%-
@svc['discovery'].each do |discovery|
-%>
name: <%= discovery['dnsdisc'] %>
connect_timeout: 0.25s
type: STRICT_DNS
dns_lookup_family: V4_ONLY
lb_policy: ROUND_ROBIN
load_assignment:
  cluster_name: cluster_<%= discovery['dnsdisc'] %>
  endpoints:
  - lb_endpoints:
    - endpoint:
        address:
          socket_address:
            address: <%= discovery['dnsdisc'] %>.discovery.wmnet
            port_value: <%= @svc['port'] %>
# Given we go through a load-balancer, we want to keep the number of requests that go through a single connection pool small
max_requests_per_connection: 1000
# Let's not enable circuit-breaking for now. It would look something like
#circuit_breakers:
#  thresholds:
#    - max_pending_requests: 30
<%- if @svc['encryption'] -%>
transport_socket:
  name: envoy.transport_sockets.tls
  typed_config:
    "@type": type.googleapis.com/envoy.api.v2.auth.UpstreamTlsContext
    common_tls_context:
       tls_params:
         tls_minimum_protocol_version: TLSv1_3
      validation_context:
        trusted_ca:
          filename: /etc/ssl/certs/ca-certificates.crt
<%- end -%>
<%- end -%>
