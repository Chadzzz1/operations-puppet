<% if @enable_sso %>
<VirtualHost *:443>
    ServerName <%= @vhost %>
    ServerAdmin <%= 'root@' + @facts['domain'] %>
    # https://httpoxy.org/
    RequestHeader unset Proxy early
    SSLEngine On
    SSLCertificateFile /etc/acmecerts/alerts/live/ec-prime256v1.crt
    SSLCertificateChainFile /etc/acmecerts/alerts/live/ec-prime256v1.chain.crt
    SSLCertificateKeyFile /etc/acmecerts/alerts/live/ec-prime256v1.key
    SSLCertificateFile /etc/acmecerts/alerts/live/rsa-2048.crt
    SSLCertificateChainFile /etc/acmecerts/alerts/live/rsa-2048.chain.crt
    SSLCertificateKeyFile /etc/acmecerts/alerts/live/rsa-2048.key
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite -ALL:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-CHACHA20-POLY1
305:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256
    SSLHonorCipherOrder On
    SSLOpenSSLConfCmd DHParameters "/etc/ssl/dhparam.pem"
    Header always set Strict-Transport-Security "max-age=106384710; includeSubDomains; preload"
    CASLoginURL https://idp.wikimedia.org/login
    CASValidateURL https://idp.wikimedia.org/serviceValidate
    CASDebug Off
    CASVersion 2
    CASCertificatePath /etc/ssl/certs
    CASCookiePath /var/cache/apache2/mod_auth_cas/
    CASAttributePrefix X-CAS-
    CASValidateSAML Off

    DocumentRoot /var/www/html

    <Directory />
        Options FollowSymLinks
        AllowOverride None
        Require all denied
    </Directory>

    <Location />
        ProxyPass "http://localhost:19194/"
        AuthType CAS
        CASAuthNHeader CAS-User
        CASScope /
        Require cas-attribute memberOf:cn=ops,ou=groups,dc=wikimedia,dc=org
        Require cas-attribute memberOf:cn=wmf,ou=groups,dc=wikimedia,dc=org
        Require cas-attribute memberOf:cn=nda,ou=groups,dc=wikimedia,dc=org
    </Location>

    <% if @readonly %>
    <Location /proxy/alertmanager>
        AllowMethods GET
    </Location>
    <% end %>

    ProxyRequests Off

    <Proxy http://localhost:19194>
        ProxySet connectiontimeout=5 timeout=90 retry=0
    </Proxy>

    ErrorLog /var/log/apache2/<%= @vhost %>_error.log
    LogLevel warn
</VirtualHost>

<VirtualHost *:80>
    ServerName <%= @vhost %>
    ServerAdmin <%= 'root@' + @facts['domain'] %>
    DocumentRoot /var/www/html

    RewriteEngine on
    RewriteCond %{SERVER_PORT} !^443$
    RewriteRule ^/(.*)$ https://<%= @vhost %>/$1 [L,R=301]

    ErrorLog /var/log/apache2/<%= @vhost %>_error.log
    LogLevel warn
</VirtualHost>

<% else %>

<VirtualHost *:80>
    ServerName <%= @vhost %>
    ServerAdmin <%= 'root@' + @facts['domain'] %>

    # Should never be seen, but apache needs this set to something
    DocumentRoot /var/www/html

    RewriteEngine on
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    RewriteRule ^/(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,E=ProtoRedirect]
    Header always merge Vary X-Forwarded-Proto env=ProtoRedirect

    <Directory />
        Options FollowSymLinks
        AllowOverride None
        Require all denied
    </Directory>

    <Location />
        ProxyPass "http://localhost:19194/"
        Require all granted
    </Location>

    <% if @readonly %>
    <Location /proxy/alertmanager>
        AllowMethods GET
    </Location>
    <% end %>

    ProxyRequests Off

    <Proxy http://localhost:19194>
        ProxySet connectiontimeout=5 timeout=90 retry=0
    </Proxy>

    # Tell caches that we are using http authentication
    Header set Vary Authorization
</VirtualHost>

<% end %>
