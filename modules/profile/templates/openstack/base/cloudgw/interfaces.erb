# managed by puppet (cloudgw)

auto lo
iface lo inet loopback

<% @all_phy_nics.each do |nic| -%>
auto <%= nic %>
iface <%= nic %> inet manual
<% end -%>

auto bond0
iface bond0 inet manual
    slaves<% @all_phy_nics.each do |nic| -%> <%= nic -%><% end %>
    bond-mode 802.3ad
    bond-miimon 100
    bond-lacp-rate fast
    bond-xmit-hash-policy layer2+3

auto vlan<%= @host_vlan %>
iface vlan<%= @host_vlan %> inet static
    vlan-raw-device bond0
    address <%= @host_addr %>
    netmask <%= @host_netm %>
    gateway <%= @host_gw %>
    dns-nameservers<% @nameservers.each do |nameserver| -%> <%= nameserver -%><% end %>
    dns-search <%= @site %>.wmnet
    up ip token set ::<%= @host_addr %> dev vlan<%= @host_vlan %>
    up ip addr add <%= @host_prefixv6 %>:<%= @host_addr %>/64 dev vlan<%= @host_vlan %>

auto vrf-cloudgw
iface vrf-cloudgw inet manual
    pre-up ip link add vrf-cloudgw type vrf table cloudgw

auto vlan<%= @virt_vlan %>
iface vlan<%= @virt_vlan %> inet static
    vlan-raw-device bond0
    address <%= @virt_addr %>
    netmask <%= @virt_netm %>
    post-up ip link set vlan<%= @virt_vlan %> master vrf-cloudgw

auto vlan<%= @wan_vlan %>
iface vlan<%= @wan_vlan %> inet static
    vlan-raw-device bond0
    address <%= @wan_addr %>
    netmask <%= @wan_netm %>
    post-up ip link set vlan<%= @wan_vlan %> master vrf-cloudgw
    post-up ip route add default via <%= @wan_gw %> table cloudgw

