# SPDX-License-Identifier: Apache-2.0
# Duplicate fired alerts to public Loki instance
filter {
  if [service][type] == "alertmanager-webhook-logger" {
    clone {
      clones => ["loki-alerts"]
      id => "filter/loki_alerts/clone"
    }

    if [type] == "loki-alerts" {
      # Alerts do not always have a consistent set of labels (like alerts generated by Grafana).
      # Here, we will set a default value of 'unknown' if needed labels are undefined.
      ruby {
        path => "/etc/logstash/filter_scripts/set_default_values.rb"
        script_params => {
          "fields" => [ "[labels][source]", "[labels][instance]", "[labels][status]" ]
          "value" => "unknown"
        }
        id => 'filter/loki_alerts/set_default_values'
      }

      mutate {
        rename => {
          "[event][kind]" => "channel"
          "[labels][source]" => "source"
          "[labels][status]" => "status"
          "[labels][instance]" => "instance"
        }
        replace => {
          "[@metadata][output]" => "loki"
        }
        id => "filter/loki_alerts/mutate"
      }

      prune {
        whitelist_names => [
          "^@timestamp$",
          "^@metadata$",
          "^message$",
          "^channel$",
          "^source",
          "^status$",
          "^instance$"
        ]
        id => "filter/loki_alerts/prune"
      }
    }
  }
}
