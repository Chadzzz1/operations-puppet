<%#- SPDX-License-Identifier: Apache-2.0 -%>
[[runners]]
  # The runnerâ€™s description. Informational only.
  name = '<%= @runner_name %>'
  # GitLab instance URL.
  url = '<%= @gitlab_url %>'
  # Select how a project should be built. Fixed to docker executor for security reasons.
  executor = "docker"

  <%- if @ensure_buildkitd == 'present' -%>
  # Provide a default variable for BUILDKIT_HOST
  environment = ["BUILDKIT_HOST=tcp://buildkitd.<%= @docker_network %>:1234"]
  <%- end -%>

  [runners.docker]
    # The image to run jobs with.
    image = '<%= @docker_image %>'
    # Disable to run container in privileged mode, for security reasons.
    privileged = false

    # Run executors on an explicit network shared with buildkitd to allow for
    # resolution of the buildkitd container by name.
    network_mode = '<%= @docker_network %>'

    # Allowed images - T291978
    allowed_images = [
      # Everything in Wikimedia registry:
      "docker-registry.wikimedia.org/**/*",

      # Distributions:
      "centos/*:*",
      "debian:*",
      "fedora:*",
      "opensuse/*:*",
      "ubuntu:*",

      # Language-specific:
      "python:*",
      "ruby:*",
      "rust:*",
      "rustlang/rust:nightly",

      # GitLab upstream - includes security analyzers and terraform images:
      "registry.gitlab.com/gitlab-org/**/*",
    ]

    allowed_services = [
      "docker-registry.wikimedia.org/**/*",
    ]
