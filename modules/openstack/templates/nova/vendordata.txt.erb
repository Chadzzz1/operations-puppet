MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="XXXXboundary text"

This is a multipart config in MIME format.
It contains a cloud-init config followed by
a first boot script.

--XXXXboundary text
MIME-Version: 1.0
Content-Type: text/jinja2; charset="us-ascii"

## template: jinja
#cloud-config

hostname: {{ds.meta_data.name}}
fqdn: {{ds.meta_data.name}}.{{ds.meta_data.project_id}}.<%= @dhcp_domain %>

# APT fails to acquire GPG keys if packages dirmngr or gpg are missing
bootcmd:
  - [ cloud-init-per, once, dirmngr-aptupdate, apt-get, update ]
  - [ cloud-init-per, once, dirmngr-aptinstall, apt-get, install, dirmngr ]
  - [ cloud-init-per, once, gnupginstall, apt-get, install, gnupg ]

# /etc/block-ldap-key-lookup:
#   Prevent non-root logins while the VM is being setup
#   The ssh-key-ldap-lookup script rejects non-root user logins if this file
#   is present.
#
# /etc/rsyslog.d/60-puppet.conf:
#   Enable console logging for puppet
#
# /etc/systemd/system/serial-getty@ttyS0.service.d/override.conf:
#   Enable root console on serial0
#   (cloud-init will create any needed parent dirs)
write_files:
    - content: "VM is work in progress"
      path: /etc/block-ldap-key-lookup
    - content: "daemon.* |/dev/console"
      path: /etc/rsyslog.d/60-puppet.conf
    - content: |
        [Service]
        ExecStart=
        ExecStart=-/sbin/agetty --autologin root --noclear %I $TERM
      path: /etc/systemd/system/serial-getty@ttyS0.service.d/override.conf

# resetting ttys0 so root is logged in
runcmd:
    - [systemctl, enable, serial-getty@ttyS0.service]
    - [systemctl, restart, serial-getty@ttyS0.service]


manage_etc_hosts: true

packages:
    - gpg
    - curl
    - nscd
    - puppet

# Clear default partitioning/mounting behavior so puppet can manage it
disk_setup:

fs_setup:

mounts:

# You'll see that we're setting apt_preserve_sources_list twice here.  That's
#  because there's a bug in cloud-init where it tries to reconcile the
#  two settings and if they're different the stage fails. That means that
#  if one of them is set differently from the default (True) then nothing
#  works.
apt_preserve_sources_list: False
apt:
    preserve_sources_list: False
    sources:
        wikimedia.list:
            source: |
                deb http://apt.wikimedia.org/wikimedia $RELEASE-wikimedia main
                deb-src http://apt.wikimedia.org/wikimedia $RELEASE-wikimedia main
            filename: wikimedia.list
            key: |
              ------BEGIN PGP PUBLIC KEY BLOCK-------
              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
              =Fawd
              ------END PGP PUBLIC KEY BLOCK-------

package_update: true
package_upgrade: true

# This configures puppet but doesn't actually puppetize anything (for unclear reasons).
#  The actual run is prompted in the boot script.
puppet:
    conf:
        agent:
            server: 'puppet'
            certname: '%f'


--XXXXboundary text
MIME-Version: 1.0
Content-Type: text/text/x-shellscript; charset="us-ascii"
#!/bin/bash

set -x

# The puppet config from cloud-init may have started the puppet agent.  If so,
#  stop it so we can run it manually in a moment.
systemctl stop puppet.service

systemctl restart nscd.service
dpkg-reconfigure -fnoninteractive -pcritical openssh-server
systemctl restart ssh.service
nscd -i hosts

puppet agent --enable
# Run puppet, twice.  The second time is just to pick up packages
#  that may have been unavailable in apt before the first puppet run
#  updated sources.list
puppet agent --onetime --verbose --no-daemonize --no-splay --show_diff

# Refresh ldap now that puppet has updated our ldap.conf
systemctl restart nslcd.service

# Ensure all NFS mounts are mounted
mount_attempts=1
until [ $mount_attempts -gt 10 ]
do
    echo "Ensuring all NFS mounts are mounted, attempt ${mount_attempts}"
    echo "Ensuring all NFS mounts are mounted, attempt ${mount_attempts}" >> /etc/block-ldap-key-lookup
    ((mount_attempts++))
    /usr/bin/timeout --preserve-status -k 10s 20s /bin/mount -a && break
    # Sleep for 10s before next attempt
    sleep 10
done

# Run puppet again post mounting NFS mounts (if all the mounts hadn't been mounted
# before, the puppet code that ensures the symlinks are created, etc may not
# have run)
puppet agent -t

# Remove the non-root login restriction
rm /etc/block-ldap-key-lookup
--XXXXboundary text
