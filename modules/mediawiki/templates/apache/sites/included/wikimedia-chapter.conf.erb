# Local user groups assimilated by AffCom to chapters are also added in this vhost.
<VirtualHost *:80>
    ServerName wikimedia-chapter

    ServerAlias ar.wikimedia.org
    ServerAlias am.wikimedia.org
    ServerAlias bd.wikimedia.org
    ServerAlias be.wikimedia.org
    ServerAlias br.wikimedia.org
    ServerAlias ca.wikimedia.org
    ServerAlias cn.wikimedia.org
    ServerAlias co.wikimedia.org
    ServerAlias dk.wikimedia.org
    ServerAlias ec.wikimedia.org
    ServerAlias ee.wikimedia.org
    ServerAlias fi.wikimedia.org
    ServerAlias hi.wikimedia.org
    ServerAlias id.wikimedia.org
    ServerAlias id-internal.wikimedia.org
    ServerAlias il.wikimedia.org
    ServerAlias mai.wikimedia.org
    ServerAlias mk.wikimedia.org
    ServerAlias mx.wikimedia.org
    ServerAlias nl.wikimedia.org
    ServerAlias no.wikimedia.org
    ServerAlias noboard-chapters.wikimedia.org
    ServerAlias nyc.wikimedia.org
    ServerAlias nz.wikimedia.org
    ServerAlias pa-us.wikimedia.org
    ServerAlias pl.wikimedia.org
    ServerAlias pt.wikimedia.org
    ServerAlias romd.wikimedia.org
    ServerAlias rs.wikimedia.org
    ServerAlias ru.wikimedia.org
    ServerAlias se.wikimedia.org
    ServerAlias tr.wikimedia.org
    ServerAlias ua.wikimedia.org
    ServerAlias us.wikimedia.org
    ServerAlias wb.wikimedia.org

    UseCanonicalName off

    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]
    RewriteMap lowercase int:tolower

    # Uploads to the host-specific directory
    # First grab the subdomain from HTTP_HOST
    RewriteCond %{HTTP_HOST} ([a-z\-]+)\.wikimedia\.org
    # Now use it
    RewriteRule ^/upload/(.*)$ %{ENV:RW_PROTO}://upload.wikimedia.org/wikimedia.org/%1/$1 [R=302]

    # www. prefix
    RewriteCond %{HTTP_HOST} ^www.([a-z]+).wikimedia.org$
    RewriteRule ^(.*)$ %{ENV:RW_PROTO}://%1.wikimedia.org$1 [R=301,L]

    # Common include for all sites using wikimedia.org as their docroot
    DocumentRoot "/srv/mediawiki/docroot/wikimedia.org"
    AllowEncodedSlashes On
    RewriteEngine On

    ProxyPass       /wiki                fcgi://127.0.0.1:9000/srv/mediawiki/docroot/wikimedia.org/w/index.php retry=0
    ProxyPass       /w/thumb_handler.php fcgi://127.0.0.1:9000/srv/mediawiki/docroot/wikimedia.org/w/thumb_handler.php retry=0
    ProxyPass       /w/extensions        !
    ProxyPassMatch  ^/w/(.*\.(php|hh))$  fcgi://127.0.0.1:9000/srv/mediawiki/docroot/wikimedia.org/w/$1 retry=0
    RewriteRule     ^/$                  fcgi://127.0.0.1:9000/srv/mediawiki/docroot/wikimedia.org/w/index.php    [P]
    RewriteRule     ^/robots\.txt$       fcgi://127.0.0.1:9000/srv/mediawiki/docroot/wikimedia.org/w/robots.php   [P]
    RewriteRule     ^/favicon\.ico$      fcgi://127.0.0.1:9000/srv/mediawiki/docroot/wikimedia.org/w/favicon.php  [P]
    # /w/wiki.phtml is severely underperforming on HHVM
    RewriteRule     ^/w/wiki.phtml$      /w/index.php [L,QSA,NE]

    # Primary wiki redirector:
    Alias /wiki /srv/mediawiki/docroot/wikimedia.org/w/index.php
    # Common include for all public wikis

    # Make robots.txt editable via Mediawiki:robots.txt
    RewriteRule ^/robots\.txt$ /w/robots.php [L]
    # Primary wiki redirector:
    RewriteRule ^/$ /w/index.php
    # Configurable favicon
    RewriteRule ^/favicon\.ico$ /w/favicon.php [L]
    # Configurable apple-touch-icon.png
    RewriteRule ^/apple-touch-icon\.png$ /w/touch.php [L]

    # Multiversion static files (T99096)
    RewriteRule ^/w/skins/.*$ /w/static.php [PT]
    RewriteRule ^/w/resources/.*$ /w/static.php [PT]
    RewriteRule ^/w/extensions/.*$ /w/static.php [PT]

    # /api/ ewrites

    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    # Common API-related rewrites

    # API listing
    RewriteRule ^/api$ %{ENV:RW_PROTO}://%{SERVER_NAME}/api/ [R=301]
    RewriteRule ^/api/$ /w/extract2.php?template=API_listing_template [L]

    # UseMod compatibility URLs
    RewriteCond %{QUERY_STRING} ([^&;]+)
    RewriteRule ^/wiki\.cgi$ %{ENV:RW_PROTO}://%{SERVER_NAME}/w/index.php?title=%1 [R=301,L]
    RewriteRule ^/wiki\.cgi$ %{ENV:RW_PROTO}://%{SERVER_NAME}/w/index.php [R=301,L]

    # Math compatibility mode
    RewriteCond %{ENV:RW_PROTO} !=""
    RewriteRule ^/math/(.*) %{ENV:RW_PROTO}://upload.wikimedia.org/math/$1 [R=301]
    RewriteRule ^/math/(.*) https://upload.wikimedia.org/math/$1 [R=301]

    # ShortUrl support, for wikis where it's enabled
    RewriteRule ^/s/.*$     /w/index.php 

    # UseMod compatibility URLs
    RewriteCond %{QUERY_STRING} ([^&;]+)
    RewriteRule ^/wiki\.cgi$ %{ENV:RW_PROTO}://%{SERVER_NAME}/w/index.php?title=%1 [R=301,L]
    RewriteRule ^/wiki\.cgi$ %{ENV:RW_PROTO}://%{SERVER_NAME}/w/index.php [R=301,L]
</VirtualHost>
