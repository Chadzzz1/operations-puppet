<%#- SPDX-License-Identifier: Apache-2.0 -%>
###
## kubernetes system config
##
## The following values are used to configure the kube-apiserver
##
#
<%-
daemon_args = [
  "--logtostderr=#{@logtostderr}",
  "--v=#{@v_log_level}",
  "--allow-privileged=#{@allow_privileged}",
  "--etcd-servers=#{@etcd_servers}",
  "--token-auth-file=/etc/kubernetes/infrastructure-users",
  "--tls-cert-file=#{@ssl_cert_path}",
  "--tls-private-key-file=#{@ssl_key_path}",
  "--service-account-key-file=#{@ssl_cert_path}",
  # disable the unprotected API port that used to be open on 127.0.0.1:8080
  "--insecure-port=0",
]

if @service_cluster_ip_range
  daemon_args.push("--service-cluster-ip-range=#{@service_cluster_ip_range}")
end
if @service_node_port_range
  daemon_args.push("--service-node-port-range=#{@service_node_port_range}")
end

if @authz_mode == 'abac'
  daemon_args.push("--authorization-mode=ABAC")
  daemon_args.push("--authorization-policy-file=/etc/kubernetes/abac")
elsif @authz_mode && @authz_mode != ''
  daemon_args.push("--authorization-mode=#{@authz_mode}")
end

if @admission_plugins
  @admission_plugins.each do |k, v|
    if !v.empty?
      daemon_args.push("--#{k}-admission-plugins=#{v.sort.join(',')}")
    end
  end
end

if @runtime_config
  daemon_args.push("--runtime-config=#{@runtime_config}")
end

if @admission_configuration
  daemon_args.push("--admission-control-config-file=#{@admission_configuration_file}")
end

if @version == '1.23'
  # From 1.20 changelog:
  # TokenRequest and TokenRequestProjection are now GA features. The following flags are required by the API server:
  #  --service-account-issuer, should be set to a URL identifying the API server that will be stable over the cluster lifetime.
  #  --service-account-key-file, set to one or more files containing one or more public keys used to verify tokens.
  #  --service-account-signing-key-file, set to a file containing a private key to use to sign service account tokens. Can be the same file given to kube-controller-manager with --service-account-private-key-file.
  daemon_args.push("--service-account-issuer=#{@service_account_issuer}")
  daemon_args.push("--service-account-key-file=#{@service_account_key}")
  daemon_args.push("--service-account-signing-key-file=#{@service_account_signing_key}")
end
-%>
DAEMON_ARGS="<%= daemon_args.sort.join(" \\\n ") %>"
