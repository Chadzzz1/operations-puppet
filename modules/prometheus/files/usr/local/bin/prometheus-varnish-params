#!/usr/bin/env bash
#
# SPDX-License-Identifier: Apache-2.0
#
# Usage: prometheus-varnish-params [outfile]

set -o errexit
set -o nounset
set -o pipefail

OUTFILE="${1:-/var/lib/prometheus/node.d/varnish_params.prom}"

# Exit successfully if the service is not running
systemctl -q is-active varnish-frontend || exit 0

# JSON output includes some stats in the front that impede jq, so slice it out
params_json="$(varnishadm -n frontend param.show -j | jq '.[3:]')"

thread_pool_max="$(jq --argjson j "$params_json" \
                   -r -n \
                   '$j[] | select(.name == "thread_pool_max").value')"
thread_pools="$(jq --argjson j "$params_json" \
                -r -n \
                '$j[] | select(.name == "thread_pools").value')"

cat <<EOF > "${OUTFILE}.$$"
# HELP varnish_param_thread_pools Number of worker thread pools
# TYPE varnish_param_thread_pools gauge
varnish_param_thread_pools $thread_pools
# HELP varnish_param_thread_pool_max Maximum number of worker threads in each pool
# TYPE varnish_param_thread_pool_max gauge
varnish_param_thread_pool_max $thread_pool_max
EOF
mv "${OUTFILE}.$$" "${OUTFILE}"
