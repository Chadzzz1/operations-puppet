#!/bin/bash

set -eu

function usage {
    cat <<EOF 1>&2
Usage: $0 MASTER

Rsync the common module from the given deployment master to the local
staging directory (/srv/mediawiki-staging)

EOF
    exit 1
}

if [[ $# -ne 1 ]]; then
    usage
fi

MASTER="$1"

if [[ $EUID -ne 0 ]]; then
    echo "$0 must be run as root" 1>&2
    exit 2
fi

/usr/bin/rsync \
    --archive --delete-delay --delay-updates --compress --delete \
    --exclude="*.swp" \
    "${MASTER}::common" /srv/mediawiki-staging

/usr/bin/rsync \
    --archive --delete-delay --delay-updates --compress --delete \
    --exclude="*.swp" \
    "${MASTER}::patches" /srv/patches
