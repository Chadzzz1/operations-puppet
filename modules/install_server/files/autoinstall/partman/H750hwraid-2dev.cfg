# SPDX-License-Identifier: Apache-2.0
# NOTE: this recipe can be used whenever a host uses the PERC H750 RAID controller
# and wishes to use an /srv volume from a RAID 10 volume in the primary drive bays.
#
# Configuration to create:
# Hardware RAID1 on 2 SFF drives in flex bays mounted at /dev/sdb
# 1G on /boot outside of LVM
# LVM volume of 95% remainder of sda is /
# Hardware RAID10 on several LFF SATA disks mounted at /dev/sda
# 95% of sdb allocated as /srv

# remove any LVM already on the disks
d-i	partman-lvm/device_remove_lvm	boolean	true
d-i	partman-lvm/confirm		boolean	true
d-i	partman-lvm/confirm_nooverwrite	boolean true


# We'll be creating LVMs and partitioning disks SDA and SDB
d-i	partman-auto/method	string	lvm
d-i	partman-auto/disk	string	/dev/sda /dev/sdb

# setup a /boot partition of 1GB outside of the LVM
d-i	partman-auto/expert_recipe	string	lvm ::	\
		1000 2000 1000 ext4	\
				$primary{ }		\
				$bootable{ }	\
				method{ format }	\
				format{ }		\
				use_filesystem{ }	\
				filesystem{ ext4 }	\
				mountpoint{ /boot }	\
				device { /dev/sdb }	\

		.	\
# setup the / filesystem within the LVM filling the 95% of the remaining space
		80000 1000 -1 ext4	\
				method{ format }	\
				format{ }		\
				use_filesystem{ }	\
				filesystem{ ext4 }	\
				lv_name{ root }		\
				$defaultignore{ }	\
				$lvmok{ }		\
				mountpoint{ / }	\
				device { /dev/sdb }	\
		.	\
# setup the SDB disk with a single LVM at 95% of the disk, and a mount in ext4 for /srv
			100000 1000 -1 ext4		\
				method{ format }	\
				format{ }		\
				use_filesystem{ }	\
				filesystem{ ext4 }	\
				lv_name{ srv }		\
				$defaultignore{ }	\
				$lvmok{ }		\
				mountpoint{ /srv }	\
				device { /dev/sda }	\


		.

d-i	partman-auto-lvm/guided_size	string	95%
d-i	partman/confirm_write_new_label	boolean	true
d-i	partman/choose_partition	select	finish
d-i	partman/confirm			boolean	true
d-i	partman/confirm_nooverwrite 	boolean	true

partman-basicfilesystems partman-basicfilesystems/no_swap boolean false


