#!/bin/bash
#
# varnishmtail - pipe varnishncsa output to mtail

PROGS="${1:-/etc/mtail}"

fmt_url='url %U'
fmt_cache_status='cache_status %{X-Cache-Status}o'
fmt_http_status='http_status %s'
fmt_http_method='http_method %m'
fmt_cache_control='cache_control %{Cache-Control}o'
fmt_inm='inm %{If-None-Match}i'

FMT="${fmt_url}\t${fmt_cache_status}\t${fmt_http_status}\t${fmt_http_method}\t${fmt_cache_control}\t${fmt_inm}\t"

/usr/bin/varnishncsa -n frontend -F "${FMT}" | mtail -progs "${PROGS}" -logs /dev/stdin
