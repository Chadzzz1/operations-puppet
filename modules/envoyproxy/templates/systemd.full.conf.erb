[Unit]
Description=Envoy proxy
Documentation=https://www.envoyproxy.io/docs/envoy/
After=network.target

[Service]
User=envoy
Restart=on-failure
Type=simple

# Ensure envoy can handle enough file descriptors
LimitNOFILE=65536

<%- if @use_hot_restarter -%>
# We use the hot-restarter script to start envoy. Please note that "restart"
# in systemd terms is stop + start, so it will not hot-restart envoy.
# We will have to use "reload" to obtain the desired result -
# and have puppet run 'systemctl reload envoyproxy.service' instead.
ExecStart=/usr/local/sbin/envoyproxy-hot-restarter /usr/local/sbin/envoyproxy-start <%= @envoy_directory %>/envoy.yaml
ExecReload=
ExecReload=/bin/kill -s HUP $MAINPID
<%- else -%>
# Ensure we're using the correct directory.
ExecStart=/usr/bin/envoy -c <%= @envoy_directory %>/envoy.yaml
<%- end -%>

# Security settings
PrivateTmp=yes
ProtectSystem=full

[Install]
WantedBy=multi-user.target
