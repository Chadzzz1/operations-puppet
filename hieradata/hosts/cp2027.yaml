profile::cache::haproxy::acls:
  - name: cache_miss
    criterion: res.hdr(X-Cache-Status)
    operator: -m str
    value: miss
  - name: cache_pass
    criterion: res.hdr(X-Cache-Status)
    operator: -m str
    value: pass

profile::cache::haproxy::sticktables:
  - name: misspassrate
    type: ipv6
    size: 1m
    expire: 60s
    store:
      - http_req_rate(10s)
  - name: newconnrate
    type: ipv6
    size: 1m
    expire: 60s
    store:
      - conn_rate(10s)

profile::cache::haproxy::stickycounters:
  - context: tcp-request connection
    key: src
    table: newconnrate
  - context: http-response
    key: src
    table: misspassrate
    condition: if cache_miss or cache_pass


lookup_options:
  profile::cache::haproxy::acls:
    merge:
      strategy: unique
