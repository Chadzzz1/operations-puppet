profile::cache::haproxy::acls:
  - name: cache_miss
    criterion: res.hdr(X-Cache-Status)
    operator: -m str
    value: miss
  - name: cache_pass
    criterion: res.hdr(X-Cache-Status)
    operator: -m str
    value: pass
  - name: backend_saturation
    criterion: be_conn
    operator: gt
    value: '1000'
  - name: concurrent_queries
    criterion: sc0_trackers(httpreqrate)
    operator: gt
    value: '80'

profile::cache::haproxy::vars:
  - direction: request
    name: req.dummy_connection_drop
    value: src,debug(would_drop,stderr)
    acl: backend_saturation concurrent_queries
  - direction: request
    name: req.dummy_excess_concurrency
    value: src,debug(excess_concurrency,stderr)
    acl: concurrent_queries


profile::cache::haproxy::sticktables:
  - name: httpreqrate
    type: ipv6
    size: 1m
    expire: 60s
    store:
      - http_req_rate(10s)

profile::cache::haproxy::stickycounters:
  - context: http-request
    key: src
    table: httpreqrate


lookup_options:
  profile::cache::haproxy::acls:
    merge:
      strategy: unique
  profile::cache::haproxy::vars:
    merge:
      strategy: unique
